<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Workout Tracker — Manage History</title>
    <meta name="theme-color" content="#64b5f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <style>
      :root {
        --bg-start: #1e1e2e; --bg-end: #2a2d3a; --card: #1a1d29; --card-2: #202332; --border:#3a3d4a; --text:#e6e7ea; --muted:#aab0bd; --blue:#64b5f6; --green:#4caf50; --yellow:#ffc107; --orange:#ff9800; --red:#f44336; --radius-lg:16px; --shadow: 0 8px 24px rgba(0,0,0,0.35); --container-w: 430px;
        --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-left: env(safe-area-inset-left, 0px); --safe-right: env(safe-area-inset-right, 0px);
      }
      *,*::before,*::after{ box-sizing: border-box; }
      html,body{ height:100%; }
      body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color:var(--text); background: linear-gradient(145deg, var(--bg-start), var(--bg-end)); }
      .phone{ max-width: var(--container-w); margin:0 auto; padding: calc(20px + var(--safe-top)) calc(16px + var(--safe-right)) calc(28px + var(--safe-bottom)) calc(16px + var(--safe-left)); }
      .card{ background: linear-gradient(180deg, var(--card), var(--card-2)); border:1px solid var(--border); border-radius: var(--radius-lg); padding: 14px; box-shadow: var(--shadow); }
      header.card h1{ margin:0; font-size:22px; font-weight:800; color: var(--blue); }
      .ghost{ display:inline-block; margin-top:8px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0f1422; color:var(--muted); font-weight:800; text-decoration:none; }
      .toolbar{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
      .btn.blue{ border-color: rgba(100,181,246,0.45); color: var(--blue); }
      .section{ margin-top:14px; }
      .title{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
      .title h2{ margin:0; font-size:18px; }
      .title .actions{ display:flex; gap:8px; }
      .btn{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#111522; color:var(--text); font-weight:700; font-size:13px; text-decoration:none; }
      .btn.red{ border-color: rgba(244,67,54,0.5); color: var(--red); }
      .list{ display:grid; gap:8px; }
      .row{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:#121522; }
      .meta{ font-size:13px; color:var(--muted); }
      .meta strong{ color: var(--text); }
      .sets{ font-size:12px; color:var(--muted); }
      .del{ padding:8px 10px; border-radius:10px; border:1px solid rgba(244,67,54,0.5); background:#1a1416; color:var(--red); font-weight:800; }
      .empty{ font-size:13px; color:var(--muted); padding:8px; }
    </style>
  </head>
  <body>
    <div class="phone">
      <header class="card">
        <h1>Manage History</h1>
        <a class="ghost" href="./home_screen_mockup.html">← Back to Home</a>
        <div class="toolbar">
          <button class="btn blue" id="exportJson">⬇️ Export JSON</button>
          <button class="btn blue" id="exportCsv">⬇️ Export CSV</button>
          <label class="btn" for="importJson" style="cursor:pointer;">⬆️ Import JSON</label>
          <input id="importJson" type="file" accept="application/json" style="display:none;" />
        </div>
      </header>

      <section class="card section">
        <div class="title"><h2>Lat Pulldown</h2><div class="actions"><a class="btn blue" href="./settings.html">⚙️ Settings</a><button class="btn red" data-clear="lat_pulldown">Delete All</button></div></div>
        <div id="list-lat" class="list"></div>
      </section>

      <section class="card section">
        <div class="title"><h2>Incline Bench Press (~30°)</h2><div class="actions"><button class="btn red" data-clear="incline_bench">Delete All</button></div></div>
        <div id="list-incline" class="list"></div>
      </section>

      <section class="card section">
        <div class="title"><h2>Dumbbell RDL</h2><div class="actions"><button class="btn red" data-clear="rdl">Delete All</button></div></div>
        <div id="list-rdl" class="list"></div>
      </section>
    </div>

    <script>
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(() => {}); }

      const EX = {
        lat_pulldown: { id:'lat_pulldown', name:'Lat Pulldown', sets:4, unit:'lb' },
        incline_bench: { id:'incline_bench', name:'Incline Bench Press (~30°)', sets:4, unit:'lb/hand' },
        rdl: { id:'rdl', name:'Dumbbell RDL', sets:3, unit:'lb/hand' }
      };
      const lists = {
        lat_pulldown: document.getElementById('list-lat'),
        incline_bench: document.getElementById('list-incline'),
        rdl: document.getElementById('list-rdl')
      };
      function fmtDateTime(iso){ const d=new Date(iso); const m=(d.getMonth()+1).toString().padStart(2,'0'); const day=d.getDate().toString().padStart(2,'0'); const hh=d.getHours().toString().padStart(2,'0'); const mm=d.getMinutes().toString().padStart(2,'0'); return `${m}/${day} ${hh}:${mm}`; }
      function totalFor(exId, sess){ return typeof sess.totalWeight==='number'? sess.totalWeight : (EX[exId].unit.includes('/hand')? (sess.weightPerHand||0)*2 : (sess.weightPerHand||0)); }
      function load(exId){ try { return JSON.parse(localStorage.getItem(`workoutclaude:history:${exId}`)||'[]'); } catch { return []; } }
      function save(exId, arr){ localStorage.setItem(`workoutclaude:history:${exId}`, JSON.stringify(arr)); }
      function loadAll(){ return Object.fromEntries(Object.keys(EX).map(id=>[id, load(id)])); }
      function render(){
        Object.keys(EX).forEach(id=>{
          const arr = load(id);
          const container = lists[id];
          container.innerHTML='';
          if(!arr.length){ container.innerHTML = '<div class="empty">No sessions yet.</div>'; return; }
          // Newest first for management convenience
          const rev = [...arr].reverse();
          rev.forEach((s, idx) => {
            const row = document.createElement('div'); row.className='row';
            const meta = document.createElement('div'); meta.className='meta';
            meta.innerHTML = `<strong>${fmtDateTime(s.dateISO)}</strong> • ${totalFor(id,s)} lb`;
            const sets = document.createElement('div'); sets.className='sets';
            const setTxt = (s.sets||[]).map((x,i)=>`S${i+1}:${x.reps||0}r/${x.rir??'-'}RIR`).join(' · ');
            sets.textContent = setTxt;
            const del = document.createElement('button'); del.className='del'; del.textContent='Delete';
            del.addEventListener('click', ()=>{
              if(!confirm('Delete this session?')) return;
              // delete corresponding element in original order
              const originalIndex = arr.length - 1 - idx; // because we reversed
              arr.splice(originalIndex,1);
              save(id, arr);
              render();
            });
            const left = document.createElement('div'); left.appendChild(meta); left.appendChild(sets);
            row.appendChild(left); row.appendChild(del);
            container.appendChild(row);
          });
        });
      }
      document.querySelectorAll('[data-clear]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-clear');
          if(!confirm(`Delete ALL sessions for ${EX[id].name}?`)) return;
          localStorage.removeItem(`workoutclaude:history:${id}`);
          render();
        });
      });
      render();

      // Export / Import helpers
      function download(filename, text, type='text/plain'){
        const blob = new Blob([text], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      document.getElementById('exportJson').addEventListener('click', ()=>{
        const payload = { version: 1, exportedAt: new Date().toISOString(), data: loadAll() };
        download('workout-history.json', JSON.stringify(payload, null, 2), 'application/json');
      });
      document.getElementById('exportCsv').addEventListener('click', ()=>{
        const all = loadAll();
        const headers = ['dateISO','exerciseId','totalWeight','weightPerHand','S1_reps','S1_rir','S2_reps','S2_rir','S3_reps','S3_rir','S4_reps','S4_rir'];
        const rows = [headers.join(',')];
        Object.keys(EX).forEach(id=>{
          (all[id]||[]).forEach(s=>{
            const wph = s.weightPerHand ?? (EX[id].unit.includes('/hand') ? (s.totalWeight||0)/2 : null);
            const cells = [
              s.dateISO,
              id,
              totalFor(id,s),
              wph ?? '',
            ];
            for(let i=0;i<4;i++){
              const set = s.sets?.[i] || {};
              cells.push(set.reps ?? '');
              cells.push(set.rir ?? '');
            }
            rows.push(cells.join(','));
          });
        });
        download('workout-history.csv', rows.join('\n'), 'text/csv');
      });
      document.getElementById('importJson').addEventListener('change', (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const payload = JSON.parse(reader.result);
            const data = payload.data || payload; // allow raw map
            Object.keys(EX).forEach(id=>{
              if(Array.isArray(data[id])){
                // Merge existing + imported, then sort by date, keep last 24
                const cur = load(id);
                const merged = [...cur, ...data[id]].sort((a,b)=>new Date(a.dateISO)-new Date(b.dateISO));
                while(merged.length>24) merged.shift();
                save(id, merged);
              }
            });
            alert('Import complete');
            render();
          }catch(err){ alert('Invalid JSON'); }
        };
        reader.readAsText(file);
      });
    </script>
  </body>
</html>
