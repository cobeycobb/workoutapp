<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Workout Tracker — Exercise (Mockup)</title>
    <meta name="theme-color" content="#64b5f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="apple-touch-icon" href="../Screenshot 2025-09-03 at 12.00.41 PM.png" />
    <style>
      :root {
        --bg-start: #1e1e2e;
        --bg-end: #2a2d3a;
        --card: #1a1d29;
        --card-2: #202332;
        --border: #3a3d4a;
        --text: #e6e7ea;
        --muted: #aab0bd;
        --blue: #64b5f6;
        --green: #4caf50;
        --yellow: #ffc107;
        --orange: #ff9800;
        --red: #f44336;
        --radius-lg: 16px;
        --radius-sm: 10px;
        --shadow: 0 8px 24px rgba(0,0,0,0.35);
        --container-w: 430px;
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(145deg, var(--bg-start), var(--bg-end));
      }
      .phone { max-width: var(--container-w); margin: 0 auto; padding: 20px 16px 28px; }

      a { color: inherit; }

      .top {
        display: grid;
        gap: 10px;
        padding: 16px;
        background: linear-gradient(180deg, rgba(100,181,246,0.12), rgba(100,181,246,0));
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
      }
      .back {
        color: var(--muted);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
      }
      .title {
        display: flex; align-items: baseline; justify-content: space-between; gap: 10px;
      }
      .title h1 { margin: 0; font-size: 24px; font-weight: 800; color: var(--blue); }
      .set-count { color: var(--muted); font-size: 13px; font-weight: 600; }

      .cue {
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(76,175,80,0.1);
        border: 1px solid rgba(76,175,80,0.35);
        color: var(--green);
        font-size: 13px;
      }

      .row {
        display: grid; gap: 12px; margin-top: 14px;
      }
      .panel {
        background: linear-gradient(180deg, var(--card), var(--card-2));
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 14px;
        box-shadow: var(--shadow);
      }

      .timer { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; }
      .time { text-align: center; font-size: 40px; font-weight: 800; color: var(--blue); letter-spacing: 1px; }
      .tbtn {
        padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
        background: #121522; color: var(--text); font-weight: 700; font-size: 14px;
      }
      .minus { border-color: rgba(255,152,0,0.45); color: var(--orange); }
      .plus  { border-color: rgba(100,181,246,0.45); color: var(--blue); }

      .weight {
        display: grid; grid-template-columns: minmax(0,1fr) max-content; gap: 14px; align-items: center;
      }
      .weight input {
        width: auto;
        min-width: 120px;
        max-width: 160px;
        justify-self: start;
        background: #111522;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 15px;
        font-weight: 700;
        position: relative; z-index: 1;
      }
      .quick {
        display: grid; grid-auto-flow: column; gap: 8px; justify-content: end;
        position: relative; z-index: 2;
        padding-left: 6px;
        background: linear-gradient(180deg, var(--card), var(--card-2));
        border-top-right-radius: 12px; border-bottom-right-radius: 12px;
      }
      .chip {
        padding: 8px 10px; border-radius: 999px; border: 1px solid var(--border);
        background: #121522; color: var(--muted); font-weight: 700; font-size: 13px;
      }
      .chip.orange { color: var(--orange); border-color: rgba(255,152,0,0.45); }
      .chip.blue   { color: var(--blue);   border-color: rgba(100,181,246,0.45); }

      .target {
        margin-top: 6px; font-size: 13px; color: var(--muted);
      }

      .bars {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: end;
        padding-top: 6px;
      }
      .bar {
        height: 120px; position: relative; border-radius: 10px; border: 1px solid var(--border);
        background: #121522; padding: 6px 4px; display: grid; grid-template-rows: repeat(10, 1fr); gap: 3px;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.25);
      }
      .seg { border-radius: 4px; border: 1px solid #2c3140; background: #0c101c; }
      .seg.y { background: linear-gradient(180deg, #ffe082, var(--yellow)); }
      .seg.g { background: linear-gradient(180deg, #81c784, var(--green)); }
      .seg.b { background: linear-gradient(180deg, #90caf9, var(--blue)); }
      .cap {
        position: absolute; top: 4px; left: 4px; right: 4px; height: 6px; border-radius: 4px; display: none;
        /* Striped overlay using light/dark bands blended with base */
        background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.16) 0 6px, rgba(0,0,0,0.16) 6px 12px);
        background-blend-mode: overlay;
      }
      .r0 { background-color: var(--red); }
      .r1 { background-color: var(--orange); }
      .r2 { background-color: var(--green); }
      .r3 { background-color: var(--blue); }
      .active { outline: 2px solid var(--blue); outline-offset: 2px; }

      .controls {
        display: grid; grid-template-columns: 1fr; gap: 12px;
      }
      .grid-nums {
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
      }
      .num, .rir {
        padding: 10px; border-radius: 10px; border: 1px solid var(--border);
        background: #111522; color: var(--text); font-weight: 800; text-align: center; cursor: pointer;
        user-select: none;
      }
      .rir { font-size: 13px; }
      .num.z1 { border-color: rgba(255,193,7,0.5); color: var(--yellow); }
      .num.z2 { border-color: rgba(76,175,80,0.5); color: var(--green); }
      .num.z3 { border-color: rgba(100,181,246,0.5); color: var(--blue); }
      .num.selected, .rir.selected { background: #182034; border-color: var(--blue); color: var(--text); }

      .rirs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
      .rir.r0 { color: var(--red); border-color: rgba(244,67,54,0.5); }
      .rir.r1 { color: var(--orange); border-color: rgba(255,152,0,0.5); }
      .rir.r2 { color: var(--green); border-color: rgba(76,175,80,0.5); }
      .rir.r3 { color: var(--blue); border-color: rgba(100,181,246,0.5); }

      .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .primary {
        grid-column: 1 / -1; padding: 14px; border-radius: 12px; border: none;
        background: linear-gradient(180deg, #73c3ff, #3aa1ff); color: #081423; font-weight: 900; box-shadow: 0 10px 24px rgba(58,161,255,0.35);
      }
      .ghost { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #0f1422; color: var(--muted); font-weight: 800; }
      .undo  { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,152,0,0.45); background: #0f1422; color: var(--orange); font-weight: 800; }
    </style>
  </head>
  <body>
    <!-- Static mockup with PWA service worker registration -->
    <div class="phone">
      <div class="top">
        <a class="back" href="./home_screen_mockup.html">← Back to Workout</a>
        <div class="title">
          <h1>Lat Pulldown</h1>
          <div class="set-count">Set 1 of 4</div>
        </div>
        <div class="cue" id="cue">Full overhead stretch</div>
      </div>

      <div class="row">
        <section class="panel">
          <div class="timer">
            <button class="tbtn minus" id="minus30">−30s</button>
            <div class="time" id="time">02:30</div>
            <button class="tbtn plus" id="plus30">+30s</button>
          </div>
          <div class="weight" style="margin-top: 12px;">
            <input id="weightInput" type="text" value="140 lb" aria-label="Working weight" />
            <div class="quick">
              <button class="chip orange" data-delta="-2.5">−2.5</button>
              <button class="chip orange" data-delta="-5">−5</button>
              <button class="chip blue" data-delta="2.5">+2.5</button>
              <button class="chip blue" data-delta="5">+5</button>
            </div>
          </div>
          <div class="target">Target: 6–10 reps with 1–2 RIR</div>
        </section>

        <section class="panel">
          <div class="bars" id="bars"></div>
        </section>

        <section class="panel controls">
          <div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700;">Select reps</div>
            <div class="grid-nums" id="repButtons"></div>
          </div>

          <div>
            <div style="font-size:12px;color:var(--muted);margin:10px 0 6px;font-weight:700;">Select RIR</div>
            <div class="rirs" id="rirButtons"></div>
          </div>

          <div class="actions">
            <button class="primary" id="logBtn">Log Set & Start Rest Timer</button>
            <a class="ghost" href="./home_screen_mockup.html">← Back to Workout</a>
            <button class="undo" id="undoBtn">↶ Undo</button>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Register service worker for PWA (scope: workoutclaude/)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(() => {});
      }
    </script>
    <script>
      // Interactive prototype logic (no backend)
      const EXERCISES = {
        lat_pulldown: {
          id: 'lat_pulldown',
          name: 'Lat Pulldown',
          sets: 4,
          defaultWeight: 140,
          unit: 'lb',
          rest: { base: 150, extended: 180 }, // 2:30 base, 3:00 if hard
          cues: ['Full overhead stretch', 'Depress first, then bend elbows']
        },
        incline_bench: {
          id: 'incline_bench',
          name: 'Incline Bench Press (~30°)',
          sets: 4,
          defaultWeight: 77.5, // per-hand weight
          unit: 'lb/hand',
          rest: { base: 150, min: 120, max: 180, extended: 180 },
          cues: ['Elbows 45–60°', '2–3s down', 'Light chest touch']
        },
        rdl: {
          id: 'rdl',
          name: 'Dumbbell RDL',
          sets: 3,
          defaultWeight: 70,
          unit: 'lb/hand',
          rest: { base: 210, min: 180, max: 240, extended: 240 }, // 3:30 base
          cues: ['3–4s down', 'Pause in stretch', 'Hips back, shins vertical']
        }
      };

      const params = new URLSearchParams(location.search);
      const exId = params.get('exercise') || 'lat_pulldown';
      const ex = EXERCISES[exId] || EXERCISES.lat_pulldown;

      const stateKey = `workoutclaude:session:${ex.id}`;
      const initialState = () => ({
        currentSet: 1,
        sets: Array.from({ length: ex.sets }, () => ({ reps: 0, rir: null })),
        weight: ex.defaultWeight,
        timerRemaining: ex.rest.base,
        timerRunning: false
      });
      let state = loadState() || initialState();
      let timerInterval = null;

      // DOM refs
      const titleEl = document.querySelector('.title h1');
      const setCountEl = document.querySelector('.set-count');
      const cueEl = document.getElementById('cue');
      const barsEl = document.getElementById('bars');
      const timeEl = document.getElementById('time');
      const minusBtn = document.getElementById('minus30');
      const plusBtn = document.getElementById('plus30');
      const weightInput = document.getElementById('weightInput');
      const logBtn = document.getElementById('logBtn');
      const undoBtn = document.getElementById('undoBtn');
      const repButtonsEl = document.getElementById('repButtons');
      const rirButtonsEl = document.getElementById('rirButtons');

      // Setup static UI
      titleEl.textContent = ex.name;
      weightInput.value = `${state.weight} ${ex.unit}`;

      // Build bars
      function buildBars() {
        barsEl.innerHTML = '';
        // columns according to sets
        barsEl.style.gridTemplateColumns = `repeat(${ex.sets}, 1fr)`;
        for (let s = 0; s < ex.sets; s++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          if (s === state.currentSet - 1) bar.classList.add('active');
          const cap = document.createElement('div');
          cap.className = 'cap';
          bar.appendChild(cap);
          for (let i = 0; i < 10; i++) {
            const seg = document.createElement('div');
            seg.className = 'seg';
            bar.appendChild(seg);
          }
          barsEl.appendChild(bar);
        }
      }

      function zoneFor(repIndexFrom1) {
        if (repIndexFrom1 <= 5) return 'y';
        if (repIndexFrom1 <= 8) return 'g';
        return 'b';
      }

      function renderBars() {
        setCountEl.textContent = `Set ${Math.min(state.currentSet, ex.sets)} of ${ex.sets}`;
        const bars = barsEl.querySelectorAll('.bar');
        bars.forEach((bar, idx) => {
          bar.classList.toggle('active', idx === state.currentSet - 1);
          const cap = bar.querySelector('.cap');
          cap.className = 'cap';
          const { reps, rir } = state.sets[idx];
          // reset cap state
          cap.style.display = 'none';
          cap.style.top = '';
          if (rir !== null) cap.classList.add(`r${Math.max(0, Math.min(3, rir))}`);
          const segs = bar.querySelectorAll('.seg');
          segs.forEach(seg => seg.className = 'seg');
          // fill from bottom up
          for (let i = 0; i < Math.min(10, reps); i++) {
            const seg = segs[segs.length - 1 - i];
            const zone = zoneFor(i + 1);
            seg.classList.add(zone);
          }
          // position RIR cap just above the highest filled rep
          if (rir !== null && reps > 0) {
            const topSeg = segs[segs.length - reps];
            if (topSeg) {
              cap.style.top = (topSeg.offsetTop - 3) + 'px';
              cap.style.display = 'block';
            }
          }
        });
      }

      function fmtTime(sec) {
        const s = Math.max(0, Math.floor(sec));
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const r = (s % 60).toString().padStart(2, '0');
        return `${m}:${r}`;
      }

      function updateTimerDisplay() {
        timeEl.textContent = fmtTime(state.timerRemaining);
        timeEl.style.color = state.timerRemaining <= 0 ? '#4caf50' : 'var(--blue)';
      }

      function startTimer(seconds) {
        state.timerRemaining = seconds ?? state.timerRemaining;
        if (timerInterval) clearInterval(timerInterval);
        state.timerRunning = true;
        timerInterval = setInterval(() => {
          state.timerRemaining -= 1;
          if (state.timerRemaining <= 0) {
            state.timerRemaining = 0;
            clearInterval(timerInterval);
            timerInterval = null;
            state.timerRunning = false;
          }
          updateTimerDisplay();
          saveState();
        }, 1000);
        updateTimerDisplay();
        saveState();
      }

      function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
        state.timerRunning = false;
        saveState();
      }

      // Rep and RIR controls
      function buildRepButtons() {
        const frag = document.createDocumentFragment();
        for (let n = 1; n <= 10; n++) {
          const el = document.createElement('div');
          el.className = `num ${n <= 5 ? 'z1' : n <= 8 ? 'z2' : 'z3'}`;
          el.textContent = n;
          el.tabIndex = 0;
          el.setAttribute('role', 'button');
          el.addEventListener('click', () => selectReps(n));
          el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') selectReps(n); });
          frag.appendChild(el);
        }
        repButtonsEl.appendChild(frag);
      }

      function buildRirButtons() {
        const opts = [
          { v: 0, label: '0 • Failure', cls: 'r0' },
          { v: 1, label: '1 • Hard', cls: 'r1' },
          { v: 2, label: '2 • Good', cls: 'r2' },
          { v: 3, label: '3 • Easy', cls: 'r3' },
        ];
        const frag = document.createDocumentFragment();
        opts.forEach(o => {
          const el = document.createElement('div');
          el.className = `rir ${o.cls}`;
          el.textContent = o.label;
          el.tabIndex = 0;
          el.setAttribute('role', 'button');
          el.addEventListener('click', () => selectRir(o.v));
          el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') selectRir(o.v); });
          frag.appendChild(el);
        });
        rirButtonsEl.appendChild(frag);
      }

      let pending = { reps: 0, rir: null };
      function selectReps(n) {
        pending.reps = n;
        [...repButtonsEl.children].forEach((c, idx) => c.classList.toggle('selected', idx + 1 === n));
        previewPending();
      }
      function selectRir(v) {
        pending.rir = v;
        [...rirButtonsEl.children].forEach((c, idx) => c.classList.toggle('selected', idx === v));
        previewPending();
      }
      function previewPending() {
        // Temporarily color the active set bar with pending reps/RIR
        const idx = state.currentSet - 1;
        const bar = barsEl.querySelectorAll('.bar')[idx];
        if (!bar) return;
        const cap = bar.querySelector('.cap');
        cap.className = 'cap';
        cap.style.display = 'none';
        cap.style.top = '';
        if (pending.rir !== null) cap.classList.add(`r${pending.rir}`);
        const segs = bar.querySelectorAll('.seg');
        segs.forEach(seg => seg.className = 'seg');
        for (let i = 0; i < Math.min(10, pending.reps || 0); i++) {
          const seg = segs[segs.length - 1 - i];
          const zone = zoneFor(i + 1);
          seg.classList.add(zone);
        }
        if (pending.rir !== null && (pending.reps || 0) > 0) {
          const topSeg = segs[segs.length - pending.reps];
          if (topSeg) {
            cap.style.top = (topSeg.offsetTop - 3) + 'px';
            cap.style.display = 'block';
          }
        }
      }

      function logSet() {
        if (!pending.reps || pending.rir === null) {
          logBtn.textContent = 'Select reps and RIR to log';
          setTimeout(() => (logBtn.textContent = 'Log Set & Start Rest Timer'), 1200);
          return;
        }
        const idx = state.currentSet - 1;
        state.sets[idx] = { reps: pending.reps, rir: pending.rir };
        // Determine rest
        let rest = ex.rest.base;
        if (pending.rir <= 1) rest = ex.rest.extended ?? ex.rest.base;
        startTimer(rest);
        // Advance set
        if (state.currentSet < ex.sets) {
          state.currentSet += 1;
          pending = { reps: 0, rir: null };
          [...repButtonsEl.children].forEach((c) => c.classList.remove('selected'));
          [...rirButtonsEl.children].forEach((c) => c.classList.remove('selected'));
        } else {
          // Completed
          logBtn.disabled = true;
          logBtn.textContent = 'All sets logged — great work!';
        }
        saveState();
        renderBars();
      }

      function undo() {
        stopTimer();
        if (state.currentSet > ex.sets || (state.currentSet === ex.sets && state.sets[ex.sets - 1].reps)) {
          // if at end and last set logged, step back from end
          state.currentSet = ex.sets;
        }
        if (state.currentSet > 1 && (!state.sets[state.currentSet - 1].reps)) {
          state.currentSet -= 1;
        }
        const idx = Math.max(0, state.currentSet - 1);
        state.sets[idx] = { reps: 0, rir: null };
        pending = { reps: 0, rir: null };
        logBtn.disabled = false;
        logBtn.textContent = 'Log Set & Start Rest Timer';
        [...repButtonsEl.children].forEach((c) => c.classList.remove('selected'));
        [...rirButtonsEl.children].forEach((c) => c.classList.remove('selected'));
        state.timerRemaining = ex.rest.base;
        updateTimerDisplay();
        saveState();
        renderBars();
      }

      function adjustWeight(delta) {
        const parsed = parseFloat((weightInput.value || '').toString().replace(/[^0-9.\-]/g, ''));
        const val = isNaN(parsed) ? state.weight : parsed;
        const next = Math.max(0, Math.round((val + delta) * 10) / 10);
        state.weight = next;
        weightInput.value = `${next} ${ex.unit}`;
        saveState();
      }

      function parseWeightInput() {
        const parsed = parseFloat((weightInput.value || '').toString().replace(/[^0-9.\-]/g, ''));
        if (!isNaN(parsed)) {
          state.weight = Math.max(0, parsed);
          weightInput.value = `${state.weight} ${ex.unit}`;
          saveState();
        } else {
          weightInput.value = `${state.weight} ${ex.unit}`;
        }
      }

      function saveState() {
        localStorage.setItem(stateKey, JSON.stringify(state));
      }
      function loadState() {
        try {
          const raw = localStorage.getItem(stateKey);
          if (!raw) return null;
          const st = JSON.parse(raw);
          // guard against spec changes
          if (!st || !Array.isArray(st.sets) || st.sets.length !== ex.sets) return null;
          return st;
        } catch { return null; }
      }

      // Event wiring
      document.querySelectorAll('.chip[data-delta]').forEach(btn => btn.addEventListener('click', () => adjustWeight(parseFloat(btn.dataset.delta))));
      weightInput.addEventListener('blur', parseWeightInput);
      weightInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); weightInput.blur(); }});
      minusBtn.addEventListener('click', () => { state.timerRemaining = Math.max(0, state.timerRemaining - 30); updateTimerDisplay(); saveState(); });
      plusBtn.addEventListener('click', () => { state.timerRemaining = Math.min(3600, state.timerRemaining + 30); updateTimerDisplay(); saveState(); });
      logBtn.addEventListener('click', logSet);
      undoBtn.addEventListener('click', undo);

      // Cue rotation
      let cueIdx = 0;
      setInterval(() => {
        cueIdx = (cueIdx + 1) % ex.cues.length;
        cueEl.style.opacity = '0';
        setTimeout(() => { cueEl.textContent = ex.cues[cueIdx]; cueEl.style.opacity = '1'; }, 180);
      }, 2500);

      // Init
      buildBars();
      buildRepButtons();
      buildRirButtons();
      renderBars();
      updateTimerDisplay();
      if (state.timerRunning && state.timerRemaining > 0) startTimer();
    </script>
  </body>
  </html>
